<view class="container">
  <!-- 标题栏 -->
  <view class="header">
    <text class="page-title">库存列表</text>
    <view class="header-actions">
      <view class="stock-actions">
        <button class="action-btn stock-in-btn" bindtap="showStockInModal">入库</button>
        <button class="action-btn stock-out-btn" bindtap="showStockOutModal">出库</button>
      </view>
      <button class="action-btn add-item-btn" bindtap="showAddDialog">+ 添加物品</button>
    </view>
  </view>

  <!-- 搜索和筛选栏 -->
  <view class="search-filter-bar">
    <view class="search-wrapper">
      <input class="search-input" 
             placeholder="请输入物品名称" 
             value="{{keyword}}"
             bindinput="onSearchInput"
             bindconfirm="onSearch" />
    </view>
    <view class="filter-wrapper">
      <picker mode="selector" 
              range="{{categoryOptionsDisplay}}"
              value="{{categoryIndex}}"
              bindchange="onCategoryChange">
        <view class="filter-item">
          <text>{{categoryOptionsDisplay[categoryIndex] || '全部分类'}}</text>
          <text class="arrow">▼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- 表格 -->
  <view class="table-container">
    <view class="table-header">
      <view class="table-cell" style="flex: 2;">物品名称</view>
      <view class="table-cell" style="flex: 1.5;">类别</view>
      <view class="table-cell" style="flex: 1;">单位</view>
      <view class="table-cell" style="flex: 1;">库存</view>
      <view class="table-cell" style="flex: 1;">预警值</view>
      <view class="table-cell" style="flex: 1;">单价</view>
      <view class="table-cell" style="flex: 1.5;">操作</view>
    </view>
    <view class="table-body">
      <view class="table-row" wx:for="{{items}}" wx:key="id">
        <view class="table-cell" style="flex: 2;">{{item.name}}</view>
        <view class="table-cell" style="flex: 1.5;">{{item.categoryDisplay || '-'}}</view>
        <view class="table-cell" style="flex: 1;">{{item.unit || '-'}}</view>
        <view class="table-cell" style="flex: 1;">{{item.quantity || 0}}</view>
        <view class="table-cell" style="flex: 1;">{{item.minStock || '-'}}</view>
        <view class="table-cell" style="flex: 1;">{{item.price ? '¥' + item.price : '-'}}</view>
        <view class="table-cell actions-cell" style="flex: 1.5;">
          <text class="action-link edit-link" data-id="{{item.id}}" catchtap="handleEdit">编辑</text>
          <text class="action-link delete-link" data-id="{{item.id}}" catchtap="handleDelete">删除</text>
        </view>
      </view>
      <view class="empty-row" wx:if="{{!loading && items.length === 0}}">
        <text>暂无物品</text>
      </view>
    </view>
  </view>

  <view class="loading" wx:if="{{loading}}">
    <text>加载中...</text>
  </view>

  <!-- 入库模态框 -->
  <view class="modal-overlay" wx:if="{{showStockInModal}}" bindtap="hideStockInModal">
    <view class="modal-content stock-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">物品入库</text>
        <text class="modal-close" bindtap="hideStockInModal">×</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">物品</text>
          <picker mode="selector" 
                  range="{{allItemsForPicker}}"
                  range-key="label"
                  value="{{stockInForm.itemIndex}}"
                  bindchange="onStockInItemChange">
            <view class="form-picker">
              <text class="{{stockInForm.itemIndex === -1 ? 'placeholder' : ''}}">
                {{stockInForm.itemIndex === -1 ? '请选择物品' : allItemsForPicker[stockInForm.itemIndex].label}}
              </text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">数量</text>
          <view class="quantity-input-wrapper">
            <button class="quantity-btn minus-btn" bindtap="decreaseQuantity" data-type="in">-</button>
            <input class="quantity-input" 
                   type="number"
                   value="{{stockInForm.quantity}}"
                   bindinput="onQuantityInput"
                   data-type="in" />
            <button class="quantity-btn plus-btn" bindtap="increaseQuantity" data-type="in">+</button>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">备注</text>
          <input class="form-input remark-input" 
                 placeholder="请输入备注" 
                 value="{{stockInForm.remark}}"
                 bindinput="onStockInRemarkInput" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="hideStockInModal">取消</button>
        <button class="modal-btn confirm-btn" bindtap="handleStockInSubmit" loading="{{submitting}}">确定</button>
      </view>
    </view>
  </view>

  <!-- 出库模态框 -->
  <view class="modal-overlay" wx:if="{{showStockOutModal}}" bindtap="hideStockOutModal">
    <view class="modal-content stock-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">物品出库</text>
        <text class="modal-close" bindtap="hideStockOutModal">×</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">物品</text>
          <picker mode="selector" 
                  range="{{allItemsForPicker}}"
                  range-key="label"
                  value="{{stockOutForm.itemIndex}}"
                  bindchange="onStockOutItemChange">
            <view class="form-picker">
              <text class="{{stockOutForm.itemIndex === -1 ? 'placeholder' : ''}}">
                {{stockOutForm.itemIndex === -1 ? '请选择物品' : allItemsForPicker[stockOutForm.itemIndex].label}}
              </text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">数量</text>
          <view class="quantity-input-wrapper">
            <button class="quantity-btn minus-btn" bindtap="decreaseQuantity" data-type="out">-</button>
            <input class="quantity-input" 
                   type="number"
                   value="{{stockOutForm.quantity}}"
                   bindinput="onQuantityInput"
                   data-type="out" />
            <button class="quantity-btn plus-btn" bindtap="increaseQuantity" data-type="out">+</button>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">备注</text>
          <input class="form-input remark-input" 
                 placeholder="请输入备注" 
                 value="{{stockOutForm.remark}}"
                 bindinput="onStockOutRemarkInput" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="hideStockOutModal">取消</button>
        <button class="modal-btn confirm-btn" bindtap="handleStockOutSubmit" loading="{{submitting}}">确定</button>
      </view>
    </view>
  </view>

  <!-- 添加物品弹窗 -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="hideAddDialog">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">添加物品</text>
        <text class="modal-close" bindtap="hideAddDialog">×</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">名称<text class="required">*</text></text>
          <input class="form-input" 
                 placeholder="请输入物品名称" 
                 value="{{addForm.name}}"
                 bindinput="onAddFormInput"
                 data-field="name" />
        </view>
        <view class="form-item">
          <text class="form-label">类别<text class="required">*</text></text>
          <picker mode="selector" 
                  range="{{categoryOptionsForAdd}}"
                  range-key="label"
                  value="{{addForm.categoryIndex}}"
                  bindchange="onCategoryPickerChange">
            <view class="form-picker">
              <text class="{{addForm.categoryIndex === 0 ? 'placeholder' : ''}}">
                {{categoryOptionsForAdd[addForm.categoryIndex].label}}
              </text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">单位</text>
          <input class="form-input" 
                 placeholder="如：瓶、个、包" 
                 value="{{addForm.unit}}"
                 bindinput="onAddFormInput"
                 data-field="unit" />
        </view>
        <view class="form-item">
          <text class="form-label">单价</text>
          <view class="price-input-wrapper">
            <button class="quantity-btn minus-btn" bindtap="decreasePrice">-</button>
            <input class="quantity-input price-input" 
                   type="digit"
                   placeholder="0.00" 
                   value="{{addForm.price}}"
                   bindinput="onAddFormInput"
                   data-field="price" />
            <button class="quantity-btn plus-btn" bindtap="increasePrice">+</button>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">预警值</text>
          <view class="price-input-wrapper">
            <button class="quantity-btn minus-btn" bindtap="decreaseMinStock">-</button>
            <input class="quantity-input price-input" 
                   type="number"
                   placeholder="0" 
                   value="{{addForm.minStock}}"
                   bindinput="onAddFormInput"
                   data-field="minStock" />
            <button class="quantity-btn plus-btn" bindtap="increaseMinStock">+</button>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">描述</text>
          <textarea class="form-textarea" 
                    placeholder="请输入物品描述" 
                    value="{{addForm.description}}"
                    bindinput="onAddFormInput"
                    data-field="description"
                    maxlength="200" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="hideAddDialog">取消</button>
        <button class="modal-btn confirm-btn" bindtap="handleAddItem" loading="{{submitting}}">确定</button>
      </view>
    </view>
  </view>

  <!-- 编辑物品弹窗 -->
  <view class="modal-overlay" wx:if="{{showEditModal}}" bindtap="hideEditDialog">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">编辑物品</text>
        <text class="modal-close" bindtap="hideEditDialog">×</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">名称<text class="required">*</text></text>
          <input class="form-input" 
                 placeholder="请输入物品名称" 
                 value="{{editForm.name}}"
                 bindinput="onEditFormInput"
                 data-field="name" />
        </view>
        <view class="form-item">
          <text class="form-label">类别<text class="required">*</text></text>
          <picker mode="selector" 
                  range="{{categoryOptionsForAdd}}"
                  range-key="label"
                  value="{{editForm.categoryIndex}}"
                  bindchange="onEditCategoryPickerChange">
            <view class="form-picker">
              <text class="{{editForm.categoryIndex === 0 ? 'placeholder' : ''}}">
                {{categoryOptionsForAdd[editForm.categoryIndex].label}}
              </text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="form-label">单位</text>
          <input class="form-input" 
                 placeholder="如：瓶、个、包" 
                 value="{{editForm.unit}}"
                 bindinput="onEditFormInput"
                 data-field="unit" />
        </view>
        <view class="form-item">
          <text class="form-label">单价</text>
          <view class="price-input-wrapper">
            <button class="quantity-btn minus-btn" bindtap="decreaseEditPrice">-</button>
            <input class="quantity-input price-input" 
                   type="digit"
                   placeholder="0.00" 
                   value="{{editForm.price}}"
                   bindinput="onEditFormInput"
                   data-field="price" />
            <button class="quantity-btn plus-btn" bindtap="increaseEditPrice">+</button>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">预警值</text>
          <view class="price-input-wrapper">
            <button class="quantity-btn minus-btn" bindtap="decreaseEditMinStock">-</button>
            <input class="quantity-input price-input" 
                   type="number"
                   placeholder="0" 
                   value="{{editForm.minStock}}"
                   bindinput="onEditFormInput"
                   data-field="minStock" />
            <button class="quantity-btn plus-btn" bindtap="increaseEditMinStock">+</button>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">描述</text>
          <textarea class="form-textarea" 
                    placeholder="请输入物品描述" 
                    value="{{editForm.description}}"
                    bindinput="onEditFormInput"
                    data-field="description"
                    maxlength="200" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="hideEditDialog">取消</button>
        <button class="modal-btn confirm-btn" bindtap="handleEditItem" loading="{{submitting}}">确定</button>
      </view>
    </view>
  </view>
</view>

